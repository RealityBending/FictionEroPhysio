<!DOCTYPE HTM>
<html>
    <head>
        <!-- Title shown in tab -->
        <title>Experiment</title>

        <!--Load JsPsych -->
        <script src="https://unpkg.com/jspsych@8.1.0"></script>
        <link
            href="https://unpkg.com/jspsych@8.1.0/css/jspsych.css"
            rel="stylesheet"
            type="text/css"
        />

        <!--Load plugins-->
        <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey@2.1.0"></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/@jspsych/plugin-survey@2.1.0/css/survey.css"
        />
        <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

        <!-- Custom scripts -->
        <script src="demographics.js"></script>
        <script src="parameters.js"></script>
        <script src="RestingState.js"></script>
    </head>

    <body></body>

    <script>

        // -----------------------
        // LSL bridge (promise-based)
        // -----------------------
        var lslBaseTime = null

        function syncLSL() {
            return new Promise(async function (resolve, reject) {
                try {
                    let offsets = []
                    for (let i = 0; i < 3; i++) {
                        var startPerf = performance.now()
                        let resp = await fetch("http://192.168.0.18:5000/sync", { cache: "no-store" })
                        let text = await resp.text()
                        var lslTime = parseFloat(text)
                        var endPerf = performance.now()
                        var perfMid = (startPerf + endPerf) / 2
                        offsets.push(lslTime - perfMid / 1000)
                        await new Promise((r) => setTimeout(r, 100)) // Short delay between syncs
                    }
                    lslBaseTime = offsets.reduce((a, b) => a + b, 0) / offsets.length
                    console.log("LSL sync done (averaged):", lslBaseTime)
                    resolve(lslBaseTime)
                } catch (e) {
                    console.error("LSL sync exception:", e)
                    reject(e)
                }
            })
        }

        function sendMarker(value = "1") {
            // If not synced, still send marker (server will timestamp with local_clock())
            if (lslBaseTime === null) {
                console.warn("LSL not synced yet - sending without JS timestamp")
                fetch("http://192.168.0.18:5000/marker?value=" + encodeURIComponent(value))
                    .then(function () {
                        console.log("sent marker (no-ts)", value)
                    })
                    .catch(function (err) {
                        console.error("Marker send error:", err)
                    })
                return
            }

            var ts = lslBaseTime + performance.now() / 1000
            var url = "http://192.168.0.18:5000/marker?value=" + encodeURIComponent(value) + "&ts=" + encodeURIComponent(ts)
            fetch(url)
                .then(function () {
                    console.log("sent marker", value, "ts", ts)
                })
                .catch(function (err) {
                    console.error("Marker send error:", err)
                })
        }


                var participant_ID = {
                    type: jsPsychSurvey,
                    survey_json: {
                        title: "About yourself",
                        completeText: "Continue",
                        pageNextText: "Next",
                        pagePrevText: "Previous",
                        goNextPageAutomatic: false,
                        showQuestionNumbers: false,
                        pages: [
                            {
                                elements: [
                                    {
                                        title: "Enter the participant's ID:",
                                        type: "text",
                                        placeholder: "000",
                                        name: "Participant_ID",
                                        isRequired: true,
                                    },
                                ],
                            },
                        ],
                    },
                    data: {
                        screen: "ppt_id_rs",
                    },
                }

        // Initialize experiment ===============================================================
        var jsPsych = initJsPsych({
            // show_progress_bar: true,
            // message_progress_bar: "Progress",
            on_finish: function () {
                // Get participant ID
                let participantID = jsPsych.data
                    .get()
                    .filter({ screen: "ppt_id_rs" })
                    .values()[0].response["Participant_ID"]

                // Save as JSON file locally
                jsPsych.data
                    .get()
                    .localSave("json", `P${participantID}_rs.json`)
            },
        })

        // Initialize timeline
        var timeline = []

        // Demographics ===========================================================
        timeline.push(participant_ID)

        timeline.push(demographics_consent)
        timeline.push({
            type: jsPsychFullscreen,
            fullscreen_mode: true,
            delay_after: 0,
        })

        timeline.push(demographics_questions1)

        //Resting State ================================================
        timeline.push(RS_instructions) // Instructions

        timeline.push(RS_buffer) // Create blank grey screen just before rest period
        timeline.push(RS_task) // Create blank grey screen for resting state
        timeline.push(RS_beep) // Play beep
        timeline.push(RS_questionnaire) // Add debriefing questionnaire

        timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: "You've reached the end of this part!",
            choices: ["Exit Fullscreen"],
            on_finish: function () {
                document.exitFullscreen()
            },
        })

        // Run the timeline =================================================================
        jsPsych.run(timeline)

        // -----------------------
        // Run: first sync then start experiment
        // -----------------------
        syncLSL()
            .then(function () {
                startExperiment()
            })
            .catch(function (err) {
                console.warn("Proceeding without LSL sync (sync failed):", err)
                startExperiment()
            })
    </script> 
</html>